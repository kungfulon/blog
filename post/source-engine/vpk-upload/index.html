<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Introduction This post will cover the exploitation chain I used to attack Source 1 Dedicated Servers. I have verified the exploit against these games:
Left 4 Dead Left 4 Dead 2 Counter-Strike: Global Offensive Source Engine file system Source Engine allows games to &amp;ldquo;mount&amp;rdquo; multiple directories as the file search path. For example, we have a and b directories. When we mount those directories to the file system, the game will access both directories under the same virtual root (like virtually merging these directories)."><title>Source Engine Exploitation: (Un)restricted file upload strikes again</title><link rel=canonical href=https://nyancat0131.moe/post/source-engine/vpk-upload/><link rel=stylesheet href=/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css><meta property="og:title" content="Source Engine Exploitation: (Un)restricted file upload strikes again"><meta property="og:description" content="Introduction This post will cover the exploitation chain I used to attack Source 1 Dedicated Servers. I have verified the exploit against these games:
Left 4 Dead Left 4 Dead 2 Counter-Strike: Global Offensive Source Engine file system Source Engine allows games to &amp;ldquo;mount&amp;rdquo; multiple directories as the file search path. For example, we have a and b directories. When we mount those directories to the file system, the game will access both directories under the same virtual root (like virtually merging these directories)."><meta property="og:url" content="https://nyancat0131.moe/post/source-engine/vpk-upload/"><meta property="og:site_name" content="nyancat0131"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="source-engine"><meta property="article:tag" content="exploit"><meta property="article:published_time" content="2022-01-27T16:58:00+07:00"><meta property="article:modified_time" content="2022-01-27T16:58:00+07:00"><meta name=twitter:title content="Source Engine Exploitation: (Un)restricted file upload strikes again"><meta name=twitter:description content="Introduction This post will cover the exploitation chain I used to attack Source 1 Dedicated Servers. I have verified the exploit against these games:
Left 4 Dead Left 4 Dead 2 Counter-Strike: Global Offensive Source Engine file system Source Engine allows games to &amp;ldquo;mount&amp;rdquo; multiple directories as the file search path. For example, we have a and b directories. When we mount those directories to the file system, the game will access both directories under the same virtual root (like virtually merging these directories)."></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column compact"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu260f869a3420d3019dc323e7e1531f15_75787_300x0_resize_box_3.png width=300 height=318 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>nyancat0131</a></h1><h2 class=site-description></h2></div></header><ol class=social-menu><li><a href=https://www.facebook.com/nyancat0131 target=_blank title=Facebook rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-facebook" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 10v4h3v7h4v-7h3l1-4h-4V8a1 1 0 011-1h3V3h-3a5 5 0 00-5 5v2H7"/></svg></a></li><li><a href=https://twitter.com/bienpnn target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=https://github.com/kungfulon target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/post/source-engine/vpk-upload/>Source Engine Exploitation: (Un)restricted file upload strikes again</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jan 27, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>8 minute read</time></div></footer></div></header><section class=article-content><h2 id=introduction>Introduction</h2><p>This post will cover the exploitation chain I used to attack Source 1 Dedicated Servers. I have verified the exploit against these games:</p><ul><li>Left 4 Dead</li><li>Left 4 Dead 2</li><li>Counter-Strike: Global Offensive</li></ul><h2 id=source-engine-file-system>Source Engine file system</h2><p>Source Engine allows games to &ldquo;mount&rdquo; multiple directories as the file search path. For example, we have <code>a</code> and <code>b</code> directories. When we mount those directories to the file system, the game will access both directories under the same virtual root (like virtually merging these directories). If there are files with the same relative path in both folders, whichever is mounted first will have greater priority.</p><p>Initially, Valve used <a class=link href=https://developer.valvesoftware.com/wiki/GCF target=_blank rel=noopener>GCF file format</a> to store game assets. It suffers from poor performance, probably <a class=link href="https://web.archive.org/web/20170915143435/http://nemesis.thewavelength.net/index.php?c=216" target=_blank rel=noopener>due to fragmentation</a>. With the release of Source Engine 2013, <a class=link href=https://developer.valvesoftware.com/wiki/VPK_File_Format target=_blank rel=noopener>VPK file format</a> was introduced to replace the old GCF file format.</p><p>Directories and VPK files are mounted by putting them into the <code>gameinfo.txt</code> file. More information on it can be found <a class=link href=https://developer.valvesoftware.com/wiki/Gameinfo.txt target=_blank rel=noopener>here</a>. As in the documentation, VPK files have to be explicitly mounted. But that changed in the L4D branch: now, when a directory is mounted, the engine will scan for <code>pakXX.vpk</code> files, with <code>XX</code> being a two-digit number from <code>01</code> to <code>98</code>, then mount them. The logic can be seen in <a class=link href=https://github.com/perilouswithadollarsign/cstrike15_src/blob/master/filesystem/basefilesystem.cpp#L2671 target=_blank rel=noopener><code>CBaseFileSystem::AddSearchPath</code> function</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>void</span> CBaseFileSystem<span style=color:#f92672>::</span>AddSearchPath( <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>pPath, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>pathID, SearchPathAdd_t addType )
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#ifdef SUPPORT_VPK
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// scan for vpk&#39;s
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span>( <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> ; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>99</span>; i<span style=color:#f92672>++</span> )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>char</span> newVPK[MAX_PATH];
</span></span><span style=display:flex><span>        sprintf( newVPK, <span style=color:#e6db74>&#34;%s/pak%02d_dir.vpk&#34;</span>, pPath, i );
</span></span><span style=display:flex><span>        <span style=color:#75715e>// we will fopen to bypass pathing, etc
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        FILE <span style=color:#f92672>*</span>pstdiofile <span style=color:#f92672>=</span> fopen( newVPK, <span style=color:#e6db74>&#34;rb&#34;</span> );
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ( pstdiofile )
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            fclose( pstdiofile );
</span></span><span style=display:flex><span>            sprintf( newVPK, <span style=color:#e6db74>&#34;%s/pak%02d.vpk&#34;</span>, pPath, i );
</span></span><span style=display:flex><span>            AddVPKFile( newVPK );
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>If users find or open a file with a relative path, the engine will always search in VPK files first. In <a class=link href=https://github.com/perilouswithadollarsign/cstrike15_src/blob/master/filesystem/basefilesystem.cpp#L4136 target=_blank rel=noopener><code>CBaseFileSystem::FindFile</code> function</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>FileHandle_t CBaseFileSystem<span style=color:#f92672>::</span>FindFile( 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> CSearchPath <span style=color:#f92672>*</span>path, 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>pFileName, 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>pOptions, 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> flags, 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>ppszResolvedFilename, 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>bool</span> bTrackCRCs )
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    VPROF( <span style=color:#e6db74>&#34;CBaseFileSystem::FindFile&#34;</span> );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> tempSymlinkBuffer[MAX_PATH];
</span></span><span style=display:flex><span>    pFileName <span style=color:#f92672>=</span> V_FormatFilenameForSymlinking( tempSymlinkBuffer, pFileName );
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    CFileOpenInfo <span style=color:#a6e22e>openInfo</span>( <span style=color:#66d9ef>this</span>, pFileName, path, pOptions, flags, ppszResolvedFilename, bTrackCRCs );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>bool</span> bIsAbsolutePath <span style=color:#f92672>=</span> V_IsAbsolutePath( pFileName );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ( bIsAbsolutePath )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span><span style=color:#75715e>#ifdef SUPPORT_VPK
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> ( m_VPKFiles.Count()  <span style=color:#f92672>&amp;&amp;</span> ( <span style=color:#f92672>!</span> V_stristr( pFileName, <span style=color:#e6db74>&#34;.vpk&#34;</span> ) ) )
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// FileSystemWarning( FILESYSTEM_WARNING, &#34;***VPK: FindFile Attempting to use full path with VPK file!\n\tFile: %s\n&#34;, pFileName );
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        openInfo.SetAbsolutePath( <span style=color:#e6db74>&#34;%s&#34;</span>, pFileName );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Check if it&#39;s of the form C:/a/b/c/blah.zip/materials/blah.vtf
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> ( HandleOpenFromZipFile( openInfo ) )
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> (FileHandle_t)openInfo.m_pFileHandle;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// check vpk file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#ifdef SUPPORT_VPK
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>for</span>( <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> ; i <span style=color:#f92672>&lt;</span> m_VPKFiles.Count(); i<span style=color:#f92672>++</span> )
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            CPackedStoreFileHandle fHandle <span style=color:#f92672>=</span> m_VPKFiles[i]<span style=color:#f92672>-&gt;</span>OpenFile( pFileName );
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> ( fHandle )
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                openInfo.m_pFileHandle <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CFileHandle(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>                openInfo.m_pFileHandle<span style=color:#f92672>-&gt;</span>m_VPKHandle <span style=color:#f92672>=</span> fHandle;
</span></span><span style=display:flex><span>                openInfo.m_pFileHandle<span style=color:#f92672>-&gt;</span>m_type <span style=color:#f92672>=</span> FT_NORMAL;
</span></span><span style=display:flex><span>                openInfo.m_pFileHandle<span style=color:#f92672>-&gt;</span>m_nLength <span style=color:#f92672>=</span> fHandle.m_nFileSize;
</span></span><span style=display:flex><span>                openInfo.SetResolvedFilename( openInfo.m_AbsolutePath );
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Remember what was returned by the Steam filesystem and track the CRC.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                openInfo.m_bLoadedFromSteamCache <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>                openInfo.m_bSteamCacheOnly <span style=color:#f92672>=</span> false;
</span></span><span style=display:flex><span>                openInfo.m_pVPKFile <span style=color:#f92672>=</span> m_VPKFiles[i];
</span></span><span style=display:flex><span>                openInfo.HandleFileCRCTracking( openInfo.m_pFileName, false );
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> ( FileHandle_t ) openInfo.m_pFileHandle;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// Caller provided a relative path
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> ( path<span style=color:#f92672>-&gt;</span>GetPackFile() )
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            HandleOpenFromPackFile( path<span style=color:#f92672>-&gt;</span>GetPackFile(), openInfo );
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> (FileHandle_t)openInfo.m_pFileHandle;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            openInfo.SetAbsolutePath( <span style=color:#e6db74>&#34;%s%s&#34;</span>, path<span style=color:#f92672>-&gt;</span>GetPathString(), pFileName );
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// now have an absolute name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    HandleOpenRegularFile( openInfo, bIsAbsolutePath );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (FileHandle_t)openInfo.m_pFileHandle;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=unrestricted-file-upload>(Un)restricted file upload</h2><p>Supports for file upload/download from both client and server has been supported since GoldSrc (Half-Life 1 engine). Community server owners mainly use it to serve custom content to players. In the beginning, people can freely <a class=link href=http://aluigi.altervista.org/adv/sourceupfile-adv.txt target=_blank rel=noopener>upload any file and use path traversal</a>. Since then, Valve has implemented more and more restrictions to the file upload feature: blocking <code>..</code> path traversal, blocking absolute paths, blocking & allowing file extensions, &mldr; but it was still being exploited now and then with either bypassing the filters or abusing the engine&rsquo;s logic. Furthermore, there are at least two versions of the filters, one for the Source 2013 branch and one for the L4D/L4D2/CS:GO branch. I don&rsquo;t know why Valve used different logic for the same feature.</p><p>Server owners can prevent clients from uploading files to the server by setting <code>sv_allowupload</code> to <code>0</code>, at the cost of clients wouldn&rsquo;t be able to use custom sprays. CS:GO is a particular case: it doesn&rsquo;t allow players to use custom sprays and instead sells them as cosmetic items. This led to Valve eventually setting <code>sv_allowupload</code> to <code>0</code> by default in <a class=link href=https://blog.counter-strike.net/index.php/2018/02/20051/ target=_blank rel=noopener>an update on 2018/08/02</a>.</p><p>In Source 2013 games, there is a separated directory to handle uploaded contents in <code>gameinfo.txt</code>. For example, in TF2:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>            <span style=color:#75715e>// Random files downloaded from gameservers go into a seperate directory, so
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// that it&#39;s easy to keep those files segregated from the official game files
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// or customizations intentially installed by the user.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// This directory is searched LAST.  If you visit a server and download
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// a custom model, etc, we don&#39;t want that file to override the default
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// game file indefinitely (after you have left the server).  Servers CAN have
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// custom content that overrides the default game files, it just needs to be
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// packed up in the .bsp file so that it will be mounted as a map search pack.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// The map search pack is mounted at the top of the search path list,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// but only while you are connected that server and on that map.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>game</span><span style=color:#f92672>+</span><span style=color:#a6e22e>download</span>   <span style=color:#a6e22e>tf</span><span style=color:#f92672>/</span><span style=color:#a6e22e>download</span>
</span></span></code></pre></div><p>But from L4D onwards, only the main game path (and DLCs) are mounted. For example, in CS:GO:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>        <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// Search paths are relative to the base directory, which is where hl2.exe is found.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// |gameinfo_path| points at the directory where gameinfo.txt is.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// We always want to mount that directory relative to gameinfo.txt, so
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// people can mount stuff in c:\mymod, and the main game resources are in
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// someplace like c:\program files\valve\steam\steamapps\&lt;username&gt;\half-life 2.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>SearchPaths</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Game</span>                <span style=color:#f92672>|</span><span style=color:#a6e22e>gameinfo_path</span><span style=color:#f92672>|</span>.
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Game</span>                <span style=color:#a6e22e>csgo</span>
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>That means the default directory for uploaded contents will be the main game path.</p><p>When the engine receives a file upload request, it will check the file path using <a class=link href=https://github.com/perilouswithadollarsign/cstrike15_src/blob/master/engine/net_chan.cpp#L3585 target=_blank rel=noopener><code>CNetChan::IsValidFileForTransfer</code> function</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>bool</span> CNetChan<span style=color:#f92672>::</span>IsValidFileForTransfer( <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>pszFilename )
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>pszFilename <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>pszFilename[<span style=color:#ae81ff>0</span>] )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// No absolute paths or weaseling up the tree with &#34;..&#34; allowed.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>COM_IsValidPath( pszFilename ) <span style=color:#f92672>||</span> V_IsAbsolutePath( pszFilename ) )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> szTemp[MAX_PATH];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> l <span style=color:#f92672>=</span> V_strlen( pszFilename );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ( l <span style=color:#f92672>&gt;=</span> <span style=color:#66d9ef>sizeof</span>(szTemp) )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>    V_strcpy_safe( szTemp, pszFilename );
</span></span><span style=display:flex><span>    V_FixSlashes( szTemp, <span style=color:#e6db74>&#39;/&#39;</span> );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ( szTemp[l<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;/&#39;</span> )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (
</span></span><span style=display:flex><span>        V_stristr( pszFilename, <span style=color:#e6db74>&#34;lua/&#34;</span> )
</span></span><span style=display:flex><span>        <span style=color:#f92672>||</span> V_stristr( pszFilename, <span style=color:#e6db74>&#34;gamemodes/&#34;</span> )
</span></span><span style=display:flex><span>        <span style=color:#f92672>||</span> V_stristr( pszFilename, <span style=color:#e6db74>&#34;scripts/&#34;</span> )
</span></span><span style=display:flex><span>        <span style=color:#f92672>||</span> V_stristr( pszFilename, <span style=color:#e6db74>&#34;addons/&#34;</span> )
</span></span><span style=display:flex><span>        <span style=color:#f92672>||</span> V_stristr( pszFilename, <span style=color:#e6db74>&#34;cfg/&#34;</span> )
</span></span><span style=display:flex><span>        <span style=color:#f92672>||</span> V_stristr( pszFilename, <span style=color:#e6db74>&#34;~/&#34;</span> )
</span></span><span style=display:flex><span>        <span style=color:#f92672>||</span> V_stristr( pszFilename, <span style=color:#e6db74>&#34;gamemodes.txt&#34;</span> )
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Allow only bsp and nav file transfers to not overwrite any assets in maps directory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> ( V_stristr( pszFilename, <span style=color:#e6db74>&#34;maps/&#34;</span> ) <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>V_stristr( pszFilename, <span style=color:#e6db74>&#34;.bsp&#34;</span> ) <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>V_stristr( pszFilename, <span style=color:#e6db74>&#34;.ain&#34;</span> ) <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>V_stristr( pszFilename, <span style=color:#e6db74>&#34;.nav&#34;</span> ) )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>extension <span style=color:#f92672>=</span> V_strrchr( pszFilename, <span style=color:#e6db74>&#39;.&#39;</span> );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>extension )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> baseLen <span style=color:#f92672>=</span> V_strlen( extension );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ( baseLen <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>||</span> baseLen <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>3</span> )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// are there any spaces in the extension? (windows exploit)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>pChar <span style=color:#f92672>=</span> extension;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> ( <span style=color:#f92672>*</span>pChar )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ( V_isspace( <span style=color:#f92672>*</span>pChar ) )
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>++</span>pChar;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.cfg&#34;</span> ) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.lst&#34;</span> ) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.lmp&#34;</span> ) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.exe&#34;</span> ) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.vbs&#34;</span> ) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.com&#34;</span> ) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.bat&#34;</span> ) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.dll&#34;</span> ) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.ini&#34;</span> ) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.log&#34;</span> ) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.lua&#34;</span> ) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.nut&#34;</span> ) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.vdf&#34;</span> ) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.smx&#34;</span> ) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.gcf&#34;</span> ) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.sys&#34;</span> ) )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> true;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We can see that the <code>.vpk</code> extension is not blocked. Along with the fact that the engine will load <code>pakXX.vpk</code> when mounting the filesystem, we can upload <code>pak02.vpk</code> to the server, and it will be mounted when the server is restarted. This is a massive win since we can put any file inside the pack file, effectively bypassing the file extension blocklist. A crash bug can be used to force the server to restart since most servers will be using an auto-restart script.</p><h2 id=code-execution>Code execution</h2><p>Now that we have unrestricted file upload, there are many ways to achieve code execution. One can chain this with a memory corruption bug (like loading a malicious model or metadata) since the engine code is unsafe. But there is an easier way: loading an external library as a <a class=link href=https://developer.valvesoftware.com/wiki/Server_plugins target=_blank rel=noopener>plugin for the engine</a>. Looking at the blocklist, we can easily see that the<code>.so</code> extension is not blocked, so we can upload a library to the server, then use the <code>plugin_load</code> console command to load the library. We can put the command into <code>cfg/autoexec.cfg</code>, then put the file into <code>pak02.vpk</code> to automatically run it when the server restart. Note that the library must be uploaded separately since the engine does not support loading a library from a VPK file.</p><h2 id=conclusion>Conclusion</h2><p>Usually, when attacking Source Engine, people tend to find a memory corruption bug since it&rsquo;s written in C/C++ and uses multiple file formats (<code>grep -i assert</code> FTW). But usually, an information disclosure bug is necessary, and it is much harder to find one. The engine is complex, and there are many mechanisms hackers can abuse to their advantage. There are still more issues that I want to talk about. Unfortunately, Valve are slow in resolving the reports. I hope you enjoy this, and stay tuned for the next article.</p><h2 id=timeline>Timeline</h2><ul><li>2021/04/24: Reported to Valve&rsquo;s HackerOne program</li><li>2021/04/29: Fixed in Counter-Strike: Global Offensive</li><li>2021/05/04: Bounty awarded ($7500)</li><li>2021/??/??: Fixed in Left 4 Dead & Left 4 Dead 2</li><li>2022/01/26: Report marked as resolved</li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/source-engine/>source-engine</a>
<a href=/tags/exploit/>exploit</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/post/ctf-writeups/alles-ctf/2021/csgo/><div class=article-details><h2 class=article-title>ALLES! CTF 2021 - ðŸ”¥ Counter Strike: Squirrel Offensive</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2023 nyancat0131</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>