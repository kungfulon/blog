<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="This challenge involves an old version of CS:GO VScript, which is vulnerable to a UAF bug and a type confusion bug.
Resources on VScript can be found here.
Here is the exploit script.
UAF by resizing array in sort compare function The sort function of squirrel array is array_sort in sqbaselib.cpp, which will call _qsort:
// v: VM, o: array object, func: compare func _qsort(v, o, 0, _array(o)-&amp;gt;Size()-1, func); The r index passed into _qsort is fixed at the beginning, so by abusing array."><title>ALLES! CTF 2021 - ðŸ”¥ Counter Strike: Squirrel Offensive</title><link rel=canonical href=https://nyancat0131.moe/post/ctf-writeups/alles-ctf/2021/csgo/><link rel=stylesheet href=/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css><meta property="og:title" content="ALLES! CTF 2021 - ðŸ”¥ Counter Strike: Squirrel Offensive"><meta property="og:description" content="This challenge involves an old version of CS:GO VScript, which is vulnerable to a UAF bug and a type confusion bug.
Resources on VScript can be found here.
Here is the exploit script.
UAF by resizing array in sort compare function The sort function of squirrel array is array_sort in sqbaselib.cpp, which will call _qsort:
// v: VM, o: array object, func: compare func _qsort(v, o, 0, _array(o)-&amp;gt;Size()-1, func); The r index passed into _qsort is fixed at the beginning, so by abusing array."><meta property="og:url" content="https://nyancat0131.moe/post/ctf-writeups/alles-ctf/2021/csgo/"><meta property="og:site_name" content="nyancat0131"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="source-engine"><meta property="article:tag" content="ctf"><meta property="article:tag" content="pwn"><meta property="article:published_time" content="2021-09-06T07:30:12+00:00"><meta property="article:modified_time" content="2021-09-06T07:30:12+00:00"><meta name=twitter:title content="ALLES! CTF 2021 - ðŸ”¥ Counter Strike: Squirrel Offensive"><meta name=twitter:description content="This challenge involves an old version of CS:GO VScript, which is vulnerable to a UAF bug and a type confusion bug.
Resources on VScript can be found here.
Here is the exploit script.
UAF by resizing array in sort compare function The sort function of squirrel array is array_sort in sqbaselib.cpp, which will call _qsort:
// v: VM, o: array object, func: compare func _qsort(v, o, 0, _array(o)-&amp;gt;Size()-1, func); The r index passed into _qsort is fixed at the beginning, so by abusing array."></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu260f869a3420d3019dc323e7e1531f15_75787_300x0_resize_box_3.png width=300 height=318 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>nyancat0131</a></h1><h2 class=site-description></h2></div></header><ol class=social-menu><li><a href=https://www.facebook.com/nyancat0131 target=_blank title=Facebook rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-facebook" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 10v4h3v7h4v-7h3l1-4h-4V8a1 1 0 011-1h3V3h-3a5 5 0 00-5 5v2H7"/></svg></a></li><li><a href=https://twitter.com/bienpnn target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=https://github.com/kungfulon target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ul><li><a href=#uaf-by-resizing-array-in-sort-compare-function>UAF by resizing array in sort compare function</a></li><li><a href=#type-confusion-in-regexp-functions>Type confusion in regexp functions</a></li><li><a href=#addresses-leaking>Addresses leaking</a></li><li><a href=#path-of-exploitation>Path of exploitation</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/post/ctf-writeups/alles-ctf/2021/csgo/>ALLES! CTF 2021 - ðŸ”¥ Counter Strike: Squirrel Offensive</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Sep 06, 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>5 minute read</time></div></footer></div></header><section class=article-content><p>This challenge involves an old version of CS:GO VScript, which is vulnerable to <a class=link href=https://github.com/albertodemichelis/squirrel/issues/220 target=_blank rel=noopener>a UAF bug and a type confusion bug</a>.</p><p>Resources on VScript can be found <a class=link href=https://developer.valvesoftware.com/wiki/VScript target=_blank rel=noopener>here</a>.</p><p><a class=link href=https://gist.githubusercontent.com/kungfulon/c50323cf6ae54104e3c65b2b30804cc1/raw/c2f6cf5a5eabea14c40ef152c83c6fff1ba5e894/exp.nut target=_blank rel=noopener>Here</a> is the exploit script.</p><h2 id=uaf-by-resizing-array-in-sort-compare-function>UAF by resizing array in sort compare function</h2><p>The sort function of squirrel array is <code>array_sort</code> in <code>sqbaselib.cpp</code>, which will call <code>_qsort</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>// v: VM, o: array object, func: compare func
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>_qsort(v, o, <span style=color:#ae81ff>0</span>, _array(o)<span style=color:#f92672>-&gt;</span>Size()<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, func);
</span></span></code></pre></div><p>The <code>r</code> index passed into <code>_qsort</code> is fixed at the beginning, so by abusing <code>array.resize</code> in compare function, we can retrieve dangling reference to freed objects through compare function parameters.</p><p>By freeing a string then overlap it with an array, the <code>_len</code> field of the freed <code>SQString</code> object will be overwritten by the <code>_sharedstate</code> field of the newly created <code>SQArray</code>. It&rsquo;s a pointer so the value will be very large, and we can use the dangling string to do arbitrary reading over a large heap space after it.</p><h2 id=type-confusion-in-regexp-functions>Type confusion in regexp functions</h2><p><code>_regexp_*</code> functions in <code>sqstdstring.cpp</code> retrieve <code>SQRex</code> object from the current object using <code>SETUP_REX</code> macro:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#define SETUP_REX(v) \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    SQRex *self = NULL; \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    sq_getinstanceup(v,1,(SQUserPointer *)&amp;self,0); 
</span></span></span></code></pre></div><p>The <code>typetag</code> parameter is <code>0</code>, means that it will not check for type mismatch. So we can call <code>_regexp_*</code> functions using any <code>instance</code> object (examples: self-defined classes, external library classes like CS:GO script classes).</p><h2 id=addresses-leaking>Addresses leaking</h2><p>As we have a long string by using UAF bug above, we can just spray a lot of <code>CScriptKeyValues</code> and find one of them using last 2 bytes of <code>SQInstance::vtable</code> as they will not be affected by Windows ASLR, then use confusion to watch for changes to <code>_userpointer</code> field. But there are other <code>instance</code> objects too, and we have no way to be sure that it&rsquo;s a <code>CScriptKeyValues</code> object.</p><p>Fortunately, the <code>tostring</code> method will return the type name and the address in memory of any object. For number and string it will just return the value. But we overlapped the freed string with an array, so we can get address of it by calling <code>tostring</code> on the array. We can keep allocate new <code>CScriptKeyValues</code> object until we get one that lies after our long string and in the range that we can read its data. I won&rsquo;t go into detail of Source Engine heap in this writeup, but most of the time we will get a satisfied object without triggering Squirrel timeout watchdog.</p><p>By reading the <code>CScriptKeyValues</code> object, we can get these values:</p><ul><li>Pointer to <code>SQInstance::vtable</code>, which can be used to calculate <code>vscript.dll</code> base address for ROP gadgets</li><li>Pointer to <code>_userpointer</code> of that object</li></ul><h2 id=path-of-exploitation>Path of exploitation</h2><p>My approach is to use a CS:GO script class, <code>CScriptKeyValues</code>. Squirrel will panic if you attempt to modify the prototype after 1 instance of a class has been created. Since in map loading, there&rsquo;re no instance of this class would be created, we can modify its prototype:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>CScriptKeyValues</span>.<span style=color:#a6e22e>confuse</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>regexp</span>.<span style=color:#a6e22e>constructor</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>CScriptKeyValues</span>.<span style=color:#a6e22e>confuse2</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>regexp</span>.<span style=color:#a6e22e>search</span>;
</span></span></code></pre></div><p>When we call any method of a CS:GO script class, <code>CSquirrelVM::TranslateCall</code> in <code>vsquirrel.cpp</code> will be called. It will access <code>_userpointer</code> field of the object to get binding information:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>pContext <span style=color:#f92672>=</span> (InstanceContext_t <span style=color:#f92672>*</span>)sa.GetInstanceUp(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>0</span>); <span style=color:#75715e>// _userpointer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>pContext )
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    sq_throwerror( hVM, <span style=color:#e6db74>&#34;Accessed null instance&#34;</span> );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> SQ_ERROR;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pObject <span style=color:#f92672>=</span> pContext<span style=color:#f92672>-&gt;</span>pInstance;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>pObject )
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    sq_throwerror( hVM, <span style=color:#e6db74>&#34;Accessed null instance&#34;</span> );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> SQ_ERROR;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> ( pContext<span style=color:#f92672>-&gt;</span>pClassDesc<span style=color:#f92672>-&gt;</span>pHelper )
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    pObject <span style=color:#f92672>=</span> pContext<span style=color:#f92672>-&gt;</span>pClassDesc<span style=color:#f92672>-&gt;</span>pHelper<span style=color:#f92672>-&gt;</span>GetProxied( pObject );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>_regexp_constructor</code> will create a new <code>SQRex</code> class and store it in <code>_userpointer</code> field. That means we can control <code>pContext</code>. Below is <code>InstanceContext_t</code> struct:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>InstanceContext_t</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>pInstance;
</span></span><span style=display:flex><span>    ScriptClassDesc_t <span style=color:#f92672>*</span>pClassDesc;
</span></span><span style=display:flex><span>    SQObjectPtr name;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>Below is <code>SQRex</code> struct:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>SQRex</span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> SQChar <span style=color:#f92672>*</span>_eol;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> SQChar <span style=color:#f92672>*</span>_bol;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> SQChar <span style=color:#f92672>*</span>_p;
</span></span><span style=display:flex><span>    SQInteger _first;
</span></span><span style=display:flex><span>    SQInteger _op;
</span></span><span style=display:flex><span>    SQRexNode <span style=color:#f92672>*</span>_nodes;
</span></span><span style=display:flex><span>    SQInteger _nallocated;
</span></span><span style=display:flex><span>    SQInteger _nsize;
</span></span><span style=display:flex><span>    SQInteger _nsubexpr;
</span></span><span style=display:flex><span>    SQRexMatch <span style=color:#f92672>*</span>_matches;
</span></span><span style=display:flex><span>    SQInteger _currsubexp;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>_jmpbuf;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> SQChar <span style=color:#f92672>**</span>_error;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p><code>pClassDesc</code> field overlaps with <code>_bol</code> field. When we call <code>_regexp_search(str)</code>, <code>_bol</code> field will be set to the beginning of <code>str</code>. So we can craft a fake <code>ScriptClassDesc_t</code> object using a string. Below is <code>ScriptClassDesc_t</code> struct:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>ScriptClassDesc_t</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>                        m_pszScriptName;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>                        m_pszClassname;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>                        m_pszDescription;
</span></span><span style=display:flex><span>    ScriptClassDesc_t <span style=color:#f92672>*</span>                    m_pBaseDesc;
</span></span><span style=display:flex><span>    CUtlVector<span style=color:#f92672>&lt;</span>ScriptFunctionBinding_t<span style=color:#f92672>&gt;</span> m_FunctionBindings;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>(<span style=color:#f92672>*</span>m_pfnConstruct)();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>m_pfnDestruct)( <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>);
</span></span><span style=display:flex><span>    IScriptInstanceHelper <span style=color:#f92672>*</span>                pHelper; <span style=color:#75715e>// offset 0x2C
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    ScriptClassDesc_t <span style=color:#f92672>*</span>                    m_pNextDesc;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>Below is <code>IScriptInstanceHelper</code> interface:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>IScriptInstanceHelper</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>GetProxied( <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>p );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>ToString</span>( <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>p, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>pBuf, <span style=color:#66d9ef>int</span> bufSize );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>BindOnRead</span>( HSCRIPT hInstance, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>pOld, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>pszId );
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>We can craft a fake <code>IScriptInstanceHelper</code> object to control the virtual method table.</p><p>Fortunately, Squirrel string is not null-terminated, so we don&rsquo;t have to worry about null bytes.</p><p>In conclusion, the fake object will look like this:</p><div class=table-wrapper><table><thead><tr><th>Offset</th><th>Content</th></tr></thead><tbody><tr><td>0x0</td><td>pivot gadget</td></tr><tr><td>&mldr;</td><td>padding</td></tr><tr><td>0x2C</td><td><code>_userpointer + 0x4</code> (<code>_bol</code>)</td></tr></tbody></table></div><h2 id=conclusion>Conclusion</h2><p>Thanks ALLES! team for organizing a great CTF with awesome challenges, and allowed late submission of ðŸ”¥ challenges.</p><p>Source Engine is a mature engine with a lot of functions, and use a lot of unsafe memory code. With the fact that any people can host dedicated servers, it&rsquo;s a huge attack surface. It&rsquo;s sad that Valve never bothers fixing security bugs in the engine quickly. I really hoped that they will pick up the pace after secret club&rsquo;s callout, but seems like they will never do that.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/source-engine/>source-engine</a>
<a href=/tags/ctf/>ctf</a>
<a href=/tags/pwn/>pwn</a></section></footer></article><footer class=site-footer><section class=copyright>&copy;
2023 nyancat0131</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>