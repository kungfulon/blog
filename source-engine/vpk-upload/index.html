<!doctype html><html lang=en-us>
<head>
<title>Source Engine Exploitation: (Un)restricted file upload strikes again // nyancat0131</title>
<link rel="shortcut icon" href=/favicon.ico>
<meta charset=utf-8>
<meta name=generator content="Hugo 0.92.1">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=author content="nyancat0131">
<meta name=description content>
<link rel=stylesheet href=https://nyancat0131.moe/css/main.min.4a7ec8660f9a44b08c4da97c5f2e31b1192df1d4d0322e65c0dbbc6ecb1b863f.css>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Source Engine Exploitation: (Un)restricted file upload strikes again">
<meta name=twitter:description content="Introduction This post will cover the exploitation chain I used to attack Source 1 Dedicated Servers. I have verified the exploit against these games:
 Left 4 Dead Left 4 Dead 2 Counter-Strike: Global Offensive  Source Engine file system Source Engine allows games to &ldquo;mount&rdquo; multiple directories as the file search path. For example, we have a and b directories. When we mount those directories to the file system, the game will access both directories under the same virtual root (like virtually merging these directories).">
<meta property="og:title" content="Source Engine Exploitation: (Un)restricted file upload strikes again">
<meta property="og:description" content="Introduction This post will cover the exploitation chain I used to attack Source 1 Dedicated Servers. I have verified the exploit against these games:
 Left 4 Dead Left 4 Dead 2 Counter-Strike: Global Offensive  Source Engine file system Source Engine allows games to &ldquo;mount&rdquo; multiple directories as the file search path. For example, we have a and b directories. When we mount those directories to the file system, the game will access both directories under the same virtual root (like virtually merging these directories).">
<meta property="og:type" content="article">
<meta property="og:url" content="https://nyancat0131.moe/source-engine/vpk-upload/"><meta property="article:section" content="source-engine">
<meta property="article:published_time" content="2022-01-27T16:58:00+07:00">
<meta property="article:modified_time" content="2022-01-27T16:58:00+07:00">
</head>
<body>
<header class=app-header>
<a href=https://nyancat0131.moe/><img class=app-header-avatar src=/avatar.png alt=nyancat0131></a>
<h1>nyancat0131</h1>
<p>Security Engineer</p>
<div class=app-header-social>
<a href=https://www.facebook.com/nyancat0131 target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-facebook"><title>Facebook</title><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg>
</a>
<a href=https://twitter.com/bienpnn target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter"><title>Twitter</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg>
</a>
<a href=https://github.com/kungfulon target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>Github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a>
</div>
</header>
<main class=app-container>
<article class=post>
<header class=post-header>
<h1 class=post-title>Source Engine Exploitation: (Un)restricted file upload strikes again</h1>
<div class=post-meta>
<div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
Jan 27, 2022
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
8 min read
</div>
</div>
</header>
<div class=post-content>
<h2 id=introduction>Introduction</h2>
<p>This post will cover the exploitation chain I used to attack Source 1 Dedicated Servers. I have verified the exploit against these games:</p>
<ul>
<li>Left 4 Dead</li>
<li>Left 4 Dead 2</li>
<li>Counter-Strike: Global Offensive</li>
</ul>
<h2 id=source-engine-file-system>Source Engine file system</h2>
<p>Source Engine allows games to &ldquo;mount&rdquo; multiple directories as the file search path. For example, we have <code>a</code> and <code>b</code> directories. When we mount those directories to the file system, the game will access both directories under the same virtual root (like virtually merging these directories). If there are files with the same relative path in both folders, whichever is mounted first will have greater priority.</p>
<p>Initially, Valve used <a href=https://developer.valvesoftware.com/wiki/GCF>GCF file format</a> to store game assets. It suffers from poor performance, probably <a href="https://web.archive.org/web/20170915143435/http://nemesis.thewavelength.net/index.php?c=216">due to fragmentation</a>. With the release of Source Engine 2013, <a href=https://developer.valvesoftware.com/wiki/VPK_File_Format>VPK file format</a> was introduced to replace the old GCF file format.</p>
<p>Directories and VPK files are mounted by putting them into the <code>gameinfo.txt</code> file. More information on it can be found <a href=https://developer.valvesoftware.com/wiki/Gameinfo.txt>here</a>. As in the documentation, VPK files have to be explicitly mounted. But that changed in the L4D branch: now, when a directory is mounted, the engine will scan for <code>pakXX.vpk</code> files, with <code>XX</code> being a two-digit number from <code>01</code> to <code>98</code>, then mount them. The logic can be seen in <a href=https://github.com/perilouswithadollarsign/cstrike15_src/blob/master/filesystem/basefilesystem.cpp#L2671><code>CBaseFileSystem::AddSearchPath</code> function</a>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#66d9ef>void</span> CBaseFileSystem<span style=color:#f92672>::</span>AddSearchPath( <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>pPath, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>pathID, SearchPathAdd_t addType )
{
    <span style=color:#75715e>// ...
</span><span style=color:#75715e></span><span style=color:#75715e>#ifdef SUPPORT_VPK
</span><span style=color:#75715e></span>    <span style=color:#75715e>// scan for vpk&#39;s
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span>( <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> ; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>99</span>; i<span style=color:#f92672>++</span> )
    {
        <span style=color:#66d9ef>char</span> newVPK[MAX_PATH];
        sprintf( newVPK, <span style=color:#e6db74>&#34;%s/pak%02d_dir.vpk&#34;</span>, pPath, i );
        <span style=color:#75715e>// we will fopen to bypass pathing, etc
</span><span style=color:#75715e></span>        FILE <span style=color:#f92672>*</span>pstdiofile <span style=color:#f92672>=</span> fopen( newVPK, <span style=color:#e6db74>&#34;rb&#34;</span> );
        <span style=color:#66d9ef>if</span> ( pstdiofile )
        {
            fclose( pstdiofile );
            sprintf( newVPK, <span style=color:#e6db74>&#34;%s/pak%02d.vpk&#34;</span>, pPath, i );
            AddVPKFile( newVPK );
        }
        <span style=color:#66d9ef>else</span>
        {
            <span style=color:#66d9ef>break</span>;
        }
    }
<span style=color:#75715e>#endif
</span><span style=color:#75715e></span>    <span style=color:#75715e>// ...
</span><span style=color:#75715e></span>}
</code></pre></div><p>If users find or open a file with a relative path, the engine will always search in VPK files first. In <a href=https://github.com/perilouswithadollarsign/cstrike15_src/blob/master/filesystem/basefilesystem.cpp#L4136><code>CBaseFileSystem::FindFile</code> function</a>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp>FileHandle_t CBaseFileSystem<span style=color:#f92672>::</span>FindFile( 
    <span style=color:#66d9ef>const</span> CSearchPath <span style=color:#f92672>*</span>path, 
    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>pFileName, 
    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>pOptions, 
    <span style=color:#66d9ef>unsigned</span> flags, 
    <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>ppszResolvedFilename, 
    <span style=color:#66d9ef>bool</span> bTrackCRCs )
{
    VPROF( <span style=color:#e6db74>&#34;CBaseFileSystem::FindFile&#34;</span> );

    <span style=color:#66d9ef>char</span> tempSymlinkBuffer[MAX_PATH];
    pFileName <span style=color:#f92672>=</span> V_FormatFilenameForSymlinking( tempSymlinkBuffer, pFileName );
    
    CFileOpenInfo <span style=color:#a6e22e>openInfo</span>( <span style=color:#66d9ef>this</span>, pFileName, path, pOptions, flags, ppszResolvedFilename, bTrackCRCs );
    <span style=color:#66d9ef>bool</span> bIsAbsolutePath <span style=color:#f92672>=</span> V_IsAbsolutePath( pFileName );
    <span style=color:#66d9ef>if</span> ( bIsAbsolutePath )
    {
<span style=color:#75715e>#ifdef SUPPORT_VPK
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> ( m_VPKFiles.Count()  <span style=color:#f92672>&amp;&amp;</span> ( <span style=color:#f92672>!</span> V_stristr( pFileName, <span style=color:#e6db74>&#34;.vpk&#34;</span> ) ) )
        {
            <span style=color:#75715e>// FileSystemWarning( FILESYSTEM_WARNING, &#34;***VPK: FindFile Attempting to use full path with VPK file!\n\tFile: %s\n&#34;, pFileName );
</span><span style=color:#75715e></span>        }
<span style=color:#75715e>#endif
</span><span style=color:#75715e></span>        openInfo.SetAbsolutePath( <span style=color:#e6db74>&#34;%s&#34;</span>, pFileName );

        <span style=color:#75715e>// Check if it&#39;s of the form C:/a/b/c/blah.zip/materials/blah.vtf
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> ( HandleOpenFromZipFile( openInfo ) )
        {
            <span style=color:#66d9ef>return</span> (FileHandle_t)openInfo.m_pFileHandle;
        }
    }
    <span style=color:#66d9ef>else</span>
    {
        <span style=color:#75715e>// check vpk file
</span><span style=color:#75715e></span><span style=color:#75715e>#ifdef SUPPORT_VPK
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>for</span>( <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> ; i <span style=color:#f92672>&lt;</span> m_VPKFiles.Count(); i<span style=color:#f92672>++</span> )
        {
            CPackedStoreFileHandle fHandle <span style=color:#f92672>=</span> m_VPKFiles[i]<span style=color:#f92672>-&gt;</span>OpenFile( pFileName );
            <span style=color:#66d9ef>if</span> ( fHandle )
            {
                openInfo.m_pFileHandle <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CFileHandle(<span style=color:#66d9ef>this</span>);
                openInfo.m_pFileHandle<span style=color:#f92672>-&gt;</span>m_VPKHandle <span style=color:#f92672>=</span> fHandle;
                openInfo.m_pFileHandle<span style=color:#f92672>-&gt;</span>m_type <span style=color:#f92672>=</span> FT_NORMAL;
                openInfo.m_pFileHandle<span style=color:#f92672>-&gt;</span>m_nLength <span style=color:#f92672>=</span> fHandle.m_nFileSize;
                openInfo.SetResolvedFilename( openInfo.m_AbsolutePath );
        
                <span style=color:#75715e>// Remember what was returned by the Steam filesystem and track the CRC.
</span><span style=color:#75715e></span>                openInfo.m_bLoadedFromSteamCache <span style=color:#f92672>=</span> false;
                openInfo.m_bSteamCacheOnly <span style=color:#f92672>=</span> false;
                openInfo.m_pVPKFile <span style=color:#f92672>=</span> m_VPKFiles[i];
                openInfo.HandleFileCRCTracking( openInfo.m_pFileName, false );
                <span style=color:#66d9ef>return</span> ( FileHandle_t ) openInfo.m_pFileHandle;
            }
        }
<span style=color:#75715e>#endif
</span><span style=color:#75715e></span>        <span style=color:#75715e>// Caller provided a relative path
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> ( path<span style=color:#f92672>-&gt;</span>GetPackFile() )
        {
            HandleOpenFromPackFile( path<span style=color:#f92672>-&gt;</span>GetPackFile(), openInfo );
            <span style=color:#66d9ef>return</span> (FileHandle_t)openInfo.m_pFileHandle;
        }
        <span style=color:#66d9ef>else</span>
        {
            openInfo.SetAbsolutePath( <span style=color:#e6db74>&#34;%s%s&#34;</span>, path<span style=color:#f92672>-&gt;</span>GetPathString(), pFileName );
        }
    }

    <span style=color:#75715e>// now have an absolute name
</span><span style=color:#75715e></span>    HandleOpenRegularFile( openInfo, bIsAbsolutePath );
    <span style=color:#66d9ef>return</span> (FileHandle_t)openInfo.m_pFileHandle;
}
</code></pre></div><h2 id=unrestricted-file-upload>(Un)restricted file upload</h2>
<p>Supports for file upload/download from both client and server has been supported since GoldSrc (Half-Life 1 engine). Community server owners mainly use it to serve custom content to players. In the beginning, people can freely <a href=http://aluigi.altervista.org/adv/sourceupfile-adv.txt>upload any file and use path traversal</a>. Since then, Valve has implemented more and more restrictions to the file upload feature: blocking <code>..</code> path traversal, blocking absolute paths, blocking & allowing file extensions, &mldr; but it was still being exploited now and then with either bypassing the filters or abusing the engine&rsquo;s logic. Furthermore, there are at least two versions of the filters, one for the Source 2013 branch and one for the L4D/L4D2/CS:GO branch. I don&rsquo;t know why Valve used different logic for the same feature.</p>
<p>Server owners can prevent clients from uploading files to the server by setting <code>sv_allowupload</code> to <code>0</code>, at the cost of clients wouldn&rsquo;t be able to use custom sprays. CS:GO is a particular case: it doesn&rsquo;t allow players to use custom sprays and instead sells them as cosmetic items. This led to Valve eventually setting <code>sv_allowupload</code> to <code>0</code> by default in <a href=https://blog.counter-strike.net/index.php/2018/02/20051/>an update on 2018/08/02</a>.</p>
<p>In Source 2013 games, there is a separated directory to handle uploaded contents in <code>gameinfo.txt</code>. For example, in TF2:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js>            <span style=color:#75715e>// Random files downloaded from gameservers go into a seperate directory, so
</span><span style=color:#75715e></span>            <span style=color:#75715e>// that it&#39;s easy to keep those files segregated from the official game files
</span><span style=color:#75715e></span>            <span style=color:#75715e>// or customizations intentially installed by the user.
</span><span style=color:#75715e></span>            <span style=color:#75715e>//
</span><span style=color:#75715e></span>            <span style=color:#75715e>// This directory is searched LAST.  If you visit a server and download
</span><span style=color:#75715e></span>            <span style=color:#75715e>// a custom model, etc, we don&#39;t want that file to override the default
</span><span style=color:#75715e></span>            <span style=color:#75715e>// game file indefinitely (after you have left the server).  Servers CAN have
</span><span style=color:#75715e></span>            <span style=color:#75715e>// custom content that overrides the default game files, it just needs to be
</span><span style=color:#75715e></span>            <span style=color:#75715e>// packed up in the .bsp file so that it will be mounted as a map search pack.
</span><span style=color:#75715e></span>            <span style=color:#75715e>// The map search pack is mounted at the top of the search path list,
</span><span style=color:#75715e></span>            <span style=color:#75715e>// but only while you are connected that server and on that map.
</span><span style=color:#75715e></span>            <span style=color:#a6e22e>game</span><span style=color:#f92672>+</span><span style=color:#a6e22e>download</span>   <span style=color:#a6e22e>tf</span><span style=color:#f92672>/</span><span style=color:#a6e22e>download</span>
</code></pre></div><p>But from L4D onwards, only the main game path (and DLCs) are mounted. For example, in CS:GO:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js>        <span style=color:#75715e>//
</span><span style=color:#75715e></span>        <span style=color:#75715e>// Search paths are relative to the base directory, which is where hl2.exe is found.
</span><span style=color:#75715e></span>        <span style=color:#75715e>//
</span><span style=color:#75715e></span>        <span style=color:#75715e>// |gameinfo_path| points at the directory where gameinfo.txt is.
</span><span style=color:#75715e></span>        <span style=color:#75715e>// We always want to mount that directory relative to gameinfo.txt, so
</span><span style=color:#75715e></span>        <span style=color:#75715e>// people can mount stuff in c:\mymod, and the main game resources are in
</span><span style=color:#75715e></span>        <span style=color:#75715e>// someplace like c:\program files\valve\steam\steamapps\&lt;username&gt;\half-life 2.
</span><span style=color:#75715e></span>        <span style=color:#75715e>//
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>SearchPaths</span>
        {
            <span style=color:#a6e22e>Game</span>                <span style=color:#f92672>|</span><span style=color:#a6e22e>gameinfo_path</span><span style=color:#f92672>|</span>.
            <span style=color:#a6e22e>Game</span>                <span style=color:#a6e22e>csgo</span>
        }
</code></pre></div><p>That means the default directory for uploaded contents will be the main game path.</p>
<p>When the engine receives a file upload request, it will check the file path using <a href=https://github.com/perilouswithadollarsign/cstrike15_src/blob/master/engine/net_chan.cpp#L3585><code>CNetChan::IsValidFileForTransfer</code> function</a>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#66d9ef>bool</span> CNetChan<span style=color:#f92672>::</span>IsValidFileForTransfer( <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>pszFilename )
{
    <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>pszFilename <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>pszFilename[<span style=color:#ae81ff>0</span>] )
        <span style=color:#66d9ef>return</span> false;

    <span style=color:#75715e>// No absolute paths or weaseling up the tree with &#34;..&#34; allowed.
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>COM_IsValidPath( pszFilename ) <span style=color:#f92672>||</span> V_IsAbsolutePath( pszFilename ) )
        <span style=color:#66d9ef>return</span> false;

    <span style=color:#66d9ef>char</span> szTemp[MAX_PATH];
    <span style=color:#66d9ef>int</span> l <span style=color:#f92672>=</span> V_strlen( pszFilename );
    <span style=color:#66d9ef>if</span> ( l <span style=color:#f92672>&gt;=</span> <span style=color:#66d9ef>sizeof</span>(szTemp) )
        <span style=color:#66d9ef>return</span> false;
    V_strcpy_safe( szTemp, pszFilename );
    V_FixSlashes( szTemp, <span style=color:#e6db74>&#39;/&#39;</span> );
    <span style=color:#66d9ef>if</span> ( szTemp[l<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;/&#39;</span> )
        <span style=color:#66d9ef>return</span> false;

    <span style=color:#66d9ef>if</span> (
        V_stristr( pszFilename, <span style=color:#e6db74>&#34;lua/&#34;</span> )
        <span style=color:#f92672>||</span> V_stristr( pszFilename, <span style=color:#e6db74>&#34;gamemodes/&#34;</span> )
        <span style=color:#f92672>||</span> V_stristr( pszFilename, <span style=color:#e6db74>&#34;scripts/&#34;</span> )
        <span style=color:#f92672>||</span> V_stristr( pszFilename, <span style=color:#e6db74>&#34;addons/&#34;</span> )
        <span style=color:#f92672>||</span> V_stristr( pszFilename, <span style=color:#e6db74>&#34;cfg/&#34;</span> )
        <span style=color:#f92672>||</span> V_stristr( pszFilename, <span style=color:#e6db74>&#34;~/&#34;</span> )
        <span style=color:#f92672>||</span> V_stristr( pszFilename, <span style=color:#e6db74>&#34;gamemodes.txt&#34;</span> )
        )
        <span style=color:#66d9ef>return</span> false;

    <span style=color:#75715e>// Allow only bsp and nav file transfers to not overwrite any assets in maps directory
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> ( V_stristr( pszFilename, <span style=color:#e6db74>&#34;maps/&#34;</span> ) <span style=color:#f92672>&amp;&amp;</span>
        <span style=color:#f92672>!</span>V_stristr( pszFilename, <span style=color:#e6db74>&#34;.bsp&#34;</span> ) <span style=color:#f92672>&amp;&amp;</span>
        <span style=color:#f92672>!</span>V_stristr( pszFilename, <span style=color:#e6db74>&#34;.ain&#34;</span> ) <span style=color:#f92672>&amp;&amp;</span>
        <span style=color:#f92672>!</span>V_stristr( pszFilename, <span style=color:#e6db74>&#34;.nav&#34;</span> ) )
        <span style=color:#66d9ef>return</span> false;

    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>extension <span style=color:#f92672>=</span> V_strrchr( pszFilename, <span style=color:#e6db74>&#39;.&#39;</span> );
    <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>extension )
        <span style=color:#66d9ef>return</span> false;

    <span style=color:#66d9ef>int</span> baseLen <span style=color:#f92672>=</span> V_strlen( extension );
    <span style=color:#66d9ef>if</span> ( baseLen <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>||</span> baseLen <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>3</span> )
        <span style=color:#66d9ef>return</span> false;

    <span style=color:#75715e>// are there any spaces in the extension? (windows exploit)
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>pChar <span style=color:#f92672>=</span> extension;
    <span style=color:#66d9ef>while</span> ( <span style=color:#f92672>*</span>pChar )
    {
        <span style=color:#66d9ef>if</span> ( V_isspace( <span style=color:#f92672>*</span>pChar ) )
        {
            <span style=color:#66d9ef>return</span> false;
        }

        <span style=color:#f92672>++</span>pChar;
    }

    <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.cfg&#34;</span> ) <span style=color:#f92672>||</span>
        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.lst&#34;</span> ) <span style=color:#f92672>||</span>
        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.lmp&#34;</span> ) <span style=color:#f92672>||</span>
        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.exe&#34;</span> ) <span style=color:#f92672>||</span>
        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.vbs&#34;</span> ) <span style=color:#f92672>||</span>
        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.com&#34;</span> ) <span style=color:#f92672>||</span>
        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.bat&#34;</span> ) <span style=color:#f92672>||</span>
        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.dll&#34;</span> ) <span style=color:#f92672>||</span>
        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.ini&#34;</span> ) <span style=color:#f92672>||</span>
        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.log&#34;</span> ) <span style=color:#f92672>||</span>
        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.lua&#34;</span> ) <span style=color:#f92672>||</span>
        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.nut&#34;</span> ) <span style=color:#f92672>||</span>
        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.vdf&#34;</span> ) <span style=color:#f92672>||</span>
        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.smx&#34;</span> ) <span style=color:#f92672>||</span>
        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.gcf&#34;</span> ) <span style=color:#f92672>||</span>
        <span style=color:#f92672>!</span>Q_strcasecmp( extension, <span style=color:#e6db74>&#34;.sys&#34;</span> ) )
    {
        <span style=color:#66d9ef>return</span> false;
    }

    <span style=color:#66d9ef>return</span> true;
}
</code></pre></div><p>We can see that the <code>.vpk</code> extension is not blocked. Along with the fact that the engine will load <code>pakXX.vpk</code> when mounting the filesystem, we can upload <code>pak02.vpk</code> to the server, and it will be mounted when the server is restarted. This is a massive win since we can put any file inside the pack file, effectively bypassing the file extension blocklist. A crash bug can be used to force the server to restart since most servers will be using an auto-restart script.</p>
<h2 id=code-execution>Code execution</h2>
<p>Now that we have unrestricted file upload, there are many ways to achieve code execution. One can chain this with a memory corruption bug (like loading a malicious model or metadata) since the engine code is unsafe. But there is an easier way: loading an external library as a <a href=https://developer.valvesoftware.com/wiki/Server_plugins>plugin for the engine</a>. Looking at the blocklist, we can easily see that the<code>.so</code> extension is not blocked, so we can upload a library to the server, then use the <code>plugin_load</code> console command to load the library. We can put the command into <code>cfg/autoexec.cfg</code>, then put the file into <code>pak02.vpk</code> to automatically run it when the server restart. Note that the library must be uploaded separately since the engine does not support loading a library from a VPK file.</p>
<h2 id=conclusion>Conclusion</h2>
<p>Usually, when attacking Source Engine, people tend to find a memory corruption bug since it&rsquo;s written in C/C++ and uses multiple file formats (<code>grep -i assert</code> FTW). But usually, an information disclosure bug is necessary, and it is much harder to find one. The engine is complex, and there are many mechanisms hackers can abuse to their advantage. There are still more issues that I want to talk about. Unfortunately, Valve are slow in resolving the reports. I hope you enjoy this, and stay tuned for the next article.</p>
<h2 id=timeline>Timeline</h2>
<ul>
<li>2021/04/24: Reported to Valve&rsquo;s HackerOne program</li>
<li>2021/04/29: Fixed in Counter-Strike: Global Offensive</li>
<li>2021/05/04: Bounty awarded ($7500)</li>
<li>2021/??/??: Fixed in Left 4 Dead & Left 4 Dead 2</li>
<li>2022/01/26: Report marked as resolved</li>
</ul>
</div>
<div class=post-footer>
</div>
</article>
</main>
</body>
</html>